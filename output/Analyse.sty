\RequirePackage{bigoperators}
\RequirePackage{tools}

\newif\if@dvar\@dvarfalse
\DeclareOption{dvar}{\@dvartrue}
\newif\if@nopar\@noparfalse
\DeclareOption{nopar}{\@nopartrue}
\DeclareOption*{}
\ProcessOptions\relax
\if@dvar
    \RequirePackage{pgffor}
\fi
\def\analyseleftp{\l}
\def\analyserightp{\right)}
\if@nopar
    \def\analyseleftp{}
    \def\analyserightp{}
\fi

\makeatletter
\newcounter{mpdercount}
\def\mpderden{}
\newcounter{mpdervarcount}
\def\prevmpdervar{}
\if@dvar
\newcommand{\scanmpderlist}[1]{
    \foreach \i in {#1}{
        \stepcounter{mpdercount}
        \comparestring{\prevmpdervar}{\i}{
            \stepcounter{mpdervarcount}
        }{
            \comparestring{\arabic{mpdervarcount}}{1}{}{\xdef\mpderden{\mpderden^{\arabic{mpdervarcount}}}}
            \xdef\mpderden{\mpderden\partial\i}
            \setcounter{mpdervarcount}{1}
            \xdef\prevmpdervar{\i}
        }
    }
    \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\mpderden^{\arabic{mpdervarcount}}}}
}
\newcommand{\scanmpder}[1]{
    \setcounter{mpdercount}{0}
    \def\mpderden{}
    \setcounter{mpdervarcount}{1}
    \def\prevmpdervar{}
    \scanmpderlist{#1}
}
\else
\def\do@scanmpder#1,{%
\ifx#1\relax
    \let\next\relax
\else
    \stepcounter{mpdercount}
    \comparestring{\prevmpdervar}{#1}{
        \stepcounter{mpdervarcount}
    }{
        \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\mpderden^{\arabic{mpdervarcount}}}}
        \edef\mpderden{\mpderden\partial#1}
        \setcounter{mpdervarcount}{1}
        \def\prevmpdervar{#1}
    }
    \let\next\do@scanmpder
\fi\next
}
\newcommand{\scanmpder}[1]{
    \setcounter{mpdercount}{0}
    \def\mpderden{}
    \setcounter{mpdervarcount}{1}
    \def\prevmpdervar{}
    \do@scanmpder#1,\relax,
    \comparestring{\arabic{mpdervarcount}}{1}{}{\edef\mpderden{\mpderden^{\arabic{mpdervarcount}}}}
}
\fi
\makeatother

\DeclareMathOperator{\dd}{d}
\newcommand{\oldd}{{\dd}}
\newcommand{\der}[1][]{\def\argI{#1}\tmpder}
\newcommand{\tmpder}[3][x]{
    \ifx&#3&
        \def\argIII{}
    \else
        \def\argIII{\analyseleftp#3\analyserightp}
    \fi\frac{\oldd^{\argI}#2}{\oldd#1^{\argI}}\argIII}
\newcommand{\pder}[1][]{\def\argI{#1}\tmppder}
\newcommand{\tmppder}[3][x]{
    \ifx&#3&
        \def\argIII{}
    \else
        \def\argIII{\analyseleftp#3\analyserightp}
    \fi\frac{\partial^{\argI}#2}{\partial#1^{\argI}}\argIII}
\newcommand{\mpder}[3][x]{\scanmpder{#1}
    \ifx&#3&
        \def\argIII{}
    \else
        \def\argIII{\analyseleftp#3\analyserightp}
    \fi\frac{\partial^{\arabic{mpdercount}}#2}{\mpderden}\argIII}
\let\oldint\int
\renewcommand{\int}[1][]{
    \ifx&#1&
        \def\argI{}
    \else
        \def\argI{{{}\dd}#1}
    \fi\tmpint}
\newcommand{\tmpint}[1][]{\def\argII{#1}\tmptmpint}
\newcommand{\tmptmpint}[2][]{\displaystyle{\oldint_{\argII}^{#1}}\analyseleftp#2\analyserightp\argI}
\newcommand{\eval}[1][]{\def\argI{#1}\tmpeval}
\newcommand{\tmpeval}[2][]{\left[#2\right]_{\argI}^{#1}}
\newcommand{\serie}[1]{\oldsum#1}
\DeclareMathOperator{\oldesc}{Esc}
\newcommand{\esc}[2][]{\oldesc_{#1}\l#2\r}
\DeclareMathOperator{\oldfnint}{Int}
\newcommand{\fnint}[1]{\oldfnint\l#1\r}
\newcommand{\nrm}[2][\infty]{\left\|#2\right\|_{#1}}
\DeclareMathOperator{\oldva}{VA}
\newcommand{\va}[1]{\oldva\l#1\r}
\DeclareMathOperator{\oldepi}{Epi}
\newcommand{\epi}[1]{\oldepi\l#1\r}