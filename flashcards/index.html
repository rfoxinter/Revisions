<!DOCTYPE html>
<html lang='fr'>
<head>
    <meta charset='utf-8'>
    <meta name='description' content='Révisions'>
    <link rel='icon' href='https://rfoxinter.github.io/favicon.ico' />
    <meta name='viewport' content='width=device-width, initial-scale=1'>
    <title>Révisions</title>
    <meta name='theme-color' content='#157878'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;700&display=swap'>
    <link rel='stylesheet' href='https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@48,400,0,0&display=swap'>
    <link rel='stylesheet' type='text/css' href='https://rfoxinter.github.io/main.css'>
    <link rel='stylesheet' type='text/css' href='https://rfoxinter.github.io/normalize.css'>
    <link rel='stylesheet' type='text/css' href='https://rfoxinter.github.io/style.css'>
    <script type="text/javascript" src="huffman.js"></script>
    <style>
        svg {
            max-width: 100%;
            max-height: calc(max(20vh, 120px)) !important;
            fill: #606c71;
            width: unset !important;
            vertical-align: middle;
        }
        path {
            stroke: #606c71;
        }
        button {
            display: inline-block;
            width: 25vw;
            min-height: 40px;
        }
    </style>
    <script type='text/javascript' defer>
        function shuffleArray(array) {
            for (let i = 0; i < array.length-1; ++i) {
                const j = Math.floor(Math.random() * (array.length));
                [array[i], array[j]] = [array[j], array[i]];
            }
        }
        function copyArray(array) {
            var cparr = new Array(array.length)
            for (let i = 0; i < array.length; ++i) {
                cparr[i] = array[i];
            }
            return cparr;
        }
        var title; var sh_quest; var sh_qr; var n; var ques; var fst; var q; var viewed; var nth; var svgcode; var arr = []; var wrong = []; var qr = [0, 1]; var lst; var fl; var syncurl; var filedate; var filename;
        const params = new URLSearchParams(document.location.search.substring(1));
        var file = params.get('file');
        var card = params.get('card');
        async function loadModule(file) {
            var response;
            try {
                response = await fetch(file + '/info.txt');
            } catch(error) {return 'Error'}
            if (response.status == 200) {
                const jsCode = await response.text();
                lst = jsCode.split('\n');
                title = lst[0].substring(lst[0].indexOf('\"') + 1, lst[0].lastIndexOf('\"'));
                sh_quest = parseInt(lst[1]);
                sh_qr = parseInt(lst[2]);
                n = lst[3].replace(']', '').replace('[', '').split(', ').map(x => parseInt(x));
                fst = lst[4].replace(']', '').replace('[', '').split(', ').map(x => parseInt(x));

                q = true;
                viewed = false;
                nth = 0;

                document.title = title.replace('&ndash;', '-').replace('<i>', '').replace('</i>', '');
                ques = copyArray(n);

                if (sh_quest) {shuffleArray(ques);}

                return 200;
            } else {return response.status;}
        }
        async function loadFile(file) {
            var response;
            try {
                response = await fetch(file);
            } catch(error) {return 'Error';}
            if (response.status == 200) {
                const jsCode = await response.text();
                fl = deflate(jsCode).split('\n');
                title = fl[0];
                sh_quest = parseInt(fl[1]);
                sh_qr = parseInt(fl[2]);
                n = fl[3].replace(']', '').replace('[', '').split(',').map(x => parseInt(x));
                fst = fl[4].replace(']', '').replace('[', '').split(',').map(x => parseInt(x));
                arr = new Array(2*n.length);
                for (let i = 0; i < 2*n.length; ++i) {
                    arr[i] = decodeURIComponent(escape(fl[5+i]));
                }
                filedate = parseInt(fl[5+2*n.length]);
                filename = fl[8+2*n.length];
                syncurl = fl[7+2*n.length];
                
                if (fl[6+2*n.length] != btoa(title)) {
                    throw new Error('Fichier corrompu')
                }

                q = true;
                viewed = false;
                nth = 0;

                document.title = title.replace('&ndash;', '-').replace('<i>', '').replace('</i>', '');
                ques = copyArray(n);

                if (sh_quest) {shuffleArray(ques);}

                return 200;
            } else {return response.status;}
        }
        async function get_code(file, ques, type) {
            var response = await fetch(file + '/' + type + ques + '.svg');
            svgcode = await response.text();
        }
        async function fill_svg(file) {
            let res = await loadModule(file);
            if (res == 200) {
                arr = new Array(2*n.length);
                await get_code(file, ques[0], 'Q');
                arr[2*ques[0]-2] = svgcode;
                if (document.readyState !== 'loading') {
                    document.getElementById('up-button').style.display = 'none';
                    document.getElementById('title').innerHTML = title;
                    document.getElementById('flip').disabled = false;
                    document.getElementById('flashcard').innerHTML = arr[2*ques[0]-2];
                    document.getElementById('card_nb').innerHTML = nth + 1;
                    document.getElementById('card_total').innerHTML = '/' + ques.length;
                } else {
                    document.addEventListener('DOMContentLoaded', onReady);
                }
                await get_code(file, ques[0], 'R');
                arr[2*ques[0]-1] = svgcode;
                for (let i = 1; i < n.length; i++) {
                    await get_code(file, ques[i], 'Q');
                    arr[2*ques[i]-2] = svgcode;
                    await get_code(file, ques[i], 'R');
                    arr[2*ques[i]-1] = svgcode;
                }
                document.getElementById('down-button').style.display = 'block';
                document.getElementById('up-button').style.display = 'block';
                document.getElementById('up-button').innerHTML = 'close';
                document.getElementById('up-button').setAttribute('onclick', '_close()');
            } else if (res == 'Error') {
                if (document.readyState !== 'loading') {
                    document.getElementById('up-button').style.display = 'none';
                    document.getElementById('title').innerHTML = 'Erreur';
                    document.getElementById('flashcard').innerHTML = 'Impossible de charger le fichier</br>Regarder le terminal (F12 puis &OpenCurlyQuote;Console&CloseCurlyQuote;) pour plus d\'informations';
                } else {
                    document.addEventListener('DOMContentLoaded', onReady);
                }
            }
            else {
                if (document.readyState !== 'loading') {
                    document.getElementById('up-button').style.display = 'none';
                    document.getElementById('title').innerHTML = 'Erreur ' + res;
                    document.getElementById('flashcard').innerHTML = 'Fichier introuvable';
                } else {
                    document.addEventListener('DOMContentLoaded', onReady);
                }
            }
        }
        async function fill_card(file) {
            let res = await loadFile(atob(card), false);
            if (res == 200) {
                document.getElementById('flip').disabled = false;
                document.getElementById('title').innerHTML = title;
                document.getElementById('flashcard').innerHTML = arr[2*ques[0]-2];
                document.getElementById('down-button').style.display = 'block';
                document.getElementById('down-button').innerHTML = 'sync';
                document.getElementById('down-button').setAttribute('onclick', 'sync()');
                document.getElementById('card_nb').innerHTML = nth + 1;
                document.getElementById('card_total').innerHTML = '/' + ques.length;
            }
        }
        if (file != null && file != '') {
            fill_svg(atob(file));
            filename = file;
        } else if (card != null && card != '') {
            fill_card(atob(card));
        }
        function reverse_card() {
            if (q) {
                document.getElementById('flashcard').innerHTML = arr[2*ques[nth]-2+qr[Number(q)]];
                document.getElementById('flip').innerHTML = 'Voir la question';
                q = false;
                viewed = true;
            } else {
                document.getElementById('flashcard').innerHTML = arr[2*ques[nth]-2+qr[Number(q)]];
                document.getElementById('flip').innerHTML = 'Voir la réponse';
                q = true;
            }
            if (viewed) {
                document.getElementById('incor').disabled = false;
                document.getElementById('corr').disabled = false;
            } else {
                document.getElementById('incor').disabled = true;
                document.getElementById('corr').disabled = true;
            }
        }
        function new_card(corr) {
            if (nth + 1 == ques.length) {
                if (!corr) {wrong.push(ques[nth]);}
                nth += 1;
                document.getElementById('flashcard').innerHTML = 'Terminé';
                document.getElementById('flip').disabled = true;
                if (wrong.length > 0) {document.getElementById('incor').disabled = false;} else {document.getElementById('incor').disabled = true;}
                document.getElementById('corr').disabled = false;
                document.getElementById('incor').innerText = 'Revoir';
                document.getElementById('corr').innerText = 'Recommencer';
                document.getElementById('card_nb').innerHTML = '';
                document.getElementById('card_total').innerHTML = '';
            } else if (nth + 1 > ques.length) {
                document.getElementById('flip').disabled = false;
                document.getElementById('incor').innerText = 'Réponse incorrecte';
                document.getElementById('corr').innerText = 'Réponse correcte';
                if (!corr) {
                    ques = copyArray(wrong);
                    shuffleArray(ques);
                    wrong = [];
                    nth = 0;
                    q = false;
                    viewed = false;
                    qr = [0, 1];
                    if (sh_qr && !fst[ques[nth]-1]) {shuffleArray(qr);}
                    reverse_card()
                } else {
                    ques = copyArray(n);
                    shuffleArray(ques);
                    wrong = [];
                    nth = 0;
                    q = false;
                    viewed = false;
                    qr = [0, 1];
                    if (sh_qr && !fst[ques[nth]-1]) {shuffleArray(qr);}
                    reverse_card()
                }
                document.getElementById('card_nb').innerHTML = nth + 1;
                document.getElementById('card_total').innerHTML = '/' + ques.length;
            } else {
                if (!corr) {wrong.push(ques[nth]);}
                nth += 1;
                q = false;
                viewed = false;
                qr = [0, 1];
                if (sh_qr && !fst[ques[nth]-1]) {shuffleArray(qr);}
                reverse_card();
                document.getElementById('card_nb').innerHTML = nth + 1;
            }
        }
        function absolute(rel) {
            var link = document.createElement("a");
            link.href = rel;
            return (link.protocol + "//" + link.host + link.pathname);
        }
        function toTitle(str) {
            return str.replace(
                /\w\S*/g,
                function(txt) {
                return txt.charAt(0).toUpperCase() + txt.substr(1).toLowerCase();
                }
            );
        }
        function download() {
            var date = new Date;
            var a = document.createElement('a');
            var text = lst[0].replaceAll('"', '') + '\n' + lst[1] + '\n' + lst[2] + '\n' + lst[3].replaceAll(' ', '') + '\n' + lst[4].replaceAll(' ', '') + '\n' + arr.map((x,i,a) => x.replaceAll('\r', '').replaceAll('\n', '')).map(x => unescape(encodeURIComponent(x))).join('\n') + '\n' + date.getFullYear() + String(date.getMonth() + 1).padStart(2, '0') + String(date.getDate()).padStart(2, '0') + String(date.getHours()).padStart(2, '0') + String(date.getMinutes()).padStart(2, '0') + String(date.getSeconds()).padStart(2, '0') + '\n' + btoa(title) + '\n' + absolute(atob(file) + (title.includes('&ndash;')?'/../..':'/..')) + 'cards.txt' + '\n' + filename;
            compress(text,toTitle(title.replace('&ndash;', '_').replace('<i>', '').replace('</i>', '').normalize('NFD').replaceAll(/[\u0300-\u036f]/g, '')).replaceAll(' ', '') + '.txt');

        }
        function _close() {
            document.title = 'Révisions';
            document.getElementById('title').innerHTML = '';
            document.getElementById('flashcard').innerHTML = '';
            document.getElementById('incor').disabled = true;
            document.getElementById('corr').disabled = true;
            document.getElementById('flip').disabled = true;
            document.getElementById('up-button').innerHTML = 'upload';
            document.getElementById('up-button').setAttribute('onclick', 'document.getElementById("open").click()');
            document.getElementById('down-button').style.display = 'none';
        }
        async function sync() {
            try {
                response = await fetch(syncurl);
            } catch(error) {window.alert('Impossible de rafraîchir le fichier.');}
            if (response.status == 200) {
                const jsCode = await response.text();
                let ls = jsCode.split('\n'); let found = false;
                for (let i = 0; i < (ls.length - 1)/2; ++i) {
                    if (ls[2*i + 1] == atob(filename)) {
                        if (parseInt(ls[2*i + 2]) > filedate) {
                            window.alert('Une mise à jour est disponible et va être chargée.');
                            document.getElementById('down-button').style.display = 'none';
                            await fill_svg(absolute(ls[0] + ls[2*i + 1]));
                            document.getElementById('down-button').style.display = 'none';
                            document.getElementById('up-button').style.display = 'block';
                            download()
                        } else {window.alert('Le fichier est à jour.')}
                        found = true;
                        break;
                    }
                }
                if (!found) {window.alert('Le fichier n\'est pas disponible.')}
            } else {window.alert('Impossible de rafraîchir le fichier.');}
        }
    </script>
    <style>
        ptr {
            cursor: pointer;
        }
        #down-button {
            position: fixed;
            top: 0;
            right: 0;
            margin: 20px;
        }
        #up-button {
            position: fixed;
            top: 0;
            left: 0;
            margin: 20px;
        }
    </style>
</head>
<body onload="document.getElementById('incor').disabled = true;document.getElementById('corr').disabled = true;document.getElementById('flip').disabled = true;document.getElementById('down-button').setAttribute('onclick', 'download()');">
    <div id='overlay'></div>
    <header class='page-header'>
        <h1 id='title'></h1>
        <input type='file' id='open' accept='.txt' hidden>
        <span class='menu-icon material-symbols-rounded'><ptr id='up-button' style='display: block;' onclick='document.getElementById("open").click()'>upload</ptr></span>
        <span class='menu-icon material-symbols-rounded'><ptr id='down-button' style='display: none;' onclick='download()'>download</ptr></span>
    </header>
    <main class='main-content'>
        <p style='text-align: center; height: calc(max(50vh,300px)); margin-bottom: 0.5rem;'>
            <span style='display: flex; align-items: center; justify-content: center; height: 100%;'>
                <span id='flashcard' style='scale: 2.5; max-width: 40%;'></span>
            </span>
        </p>
        <p style='text-align: center; margin-bottom: 0.5rem;'>
            <span id='card_nb'></span><span id='card_total'></span>
        </p>
        <p style='text-align: center;'>
            <button id='flip' onclick='reverse_card()' disabled>Voir la réponse</button>
        </p>
        <p>
            <button id='incor' onclick='new_card(false)' style='position: relative; left: 15vw; color: #EC7063;' disabled>Réponse incorrecte</button><button id='corr' onclick='new_card(true)' style='position: relative; left: calc(100% - 65vw); color: #159957;' disabled>Réponse correcte</button>
        </p>
    </main>
    <footer class='site-footer'>
        <a href='./MP2I/'><img src='https://rfoxinter.github.io/home.svg' class='home' alt='home'></a>
    </footer>
    <script>
        document.getElementById('open').addEventListener('change', function() {
            fl = new FileReader();
            if (document.getElementById('open').value != '') {
                fl.onload = function(){
                    try {
                        fl = deflate(fl.result).split('\n');
                        title = fl[0];
                        sh_quest = parseInt(fl[1]);
                        sh_qr = parseInt(fl[2]);
                        n = fl[3].replace(']', '').replace('[', '').split(',').map(x => parseInt(x));
                        fst = fl[4].replace(']', '').replace('[', '').split(',').map(x => parseInt(x));
                        arr = new Array(2*n.length);
                        for (let i = 0; i < 2*n.length; ++i) {
                            arr[i] = decodeURIComponent(escape(fl[5+i]));
                        }
                        filedate = parseInt(fl[5+2*n.length]);
                        filename = fl[8+2*n.length];
                        syncurl = fl[7+2*n.length];
                        
                        if (fl[6+2*n.length] != btoa(title)) {
                            throw new Error('Fichier corrompu')
                        }
                        document.getElementById('up-button').innerHTML = 'close';
                        document.getElementById('up-button').setAttribute('onclick', '_close()');

                        q = true;
                        viewed = false;
                        nth = 0;

                        document.title = title.replace('&ndash;', '-').replace('<i>', '').replace('</i>', '');
                        ques = copyArray(n);

                        if (sh_quest) {shuffleArray(ques);}

                        document.getElementById('flip').disabled = false;
                        document.getElementById('title').innerHTML = title;
                        document.getElementById('flashcard').innerHTML = arr[2*ques[0]-2];
                        document.getElementById('down-button').style.display = 'block';
                        document.getElementById('down-button').innerHTML = 'sync';
                        document.getElementById('down-button').setAttribute('onclick', 'sync()');
                        document.getElementById('card_nb').innerHTML = nth + 1;
                        document.getElementById('card_total').innerHTML = '/' + ques.length;

                        document.getElementById('open').value = '';
                    } catch(error) {
                        document.getElementById('title').innerHTML = 'Erreur';
                        document.getElementById('flashcard').innerHTML = 'Le fichier n&CloseCurlyQuote;est pas compatible';
                    }
                }
            }
            fl.readAsText(this.files[0]);
        })
    </script>
</body>
</html>
